<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Interactive Bill Viewer – H.R. 1 (EAS)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{
  --accent:#0057e7; --bg:#fff; --text:#222; --tag:#e0e7ff; --sidebar:270px;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font:15px/1.5 system-ui,sans-serif;background:var(--bg);color:var(--text);}
header{display:flex;align-items:center;gap:.5rem;padding:.6rem 1rem;background:var(--accent);color:#fff;}
header h1{font-size:1rem;flex:1;margin-inline-start:.25rem;}
header input{flex:2;max-width:320px;border:0;border-radius:4px;padding:.42rem .6rem;}
#menuBtn{background:none;border:0;font-size:1.5rem;color:#fff;cursor:pointer;}
aside{position:fixed;inset-block:0;inset-inline-start:0;width:var(--sidebar);background:#f7f8fb;overflow:auto;transform:translateX(-100%);transition:transform .3s;}
aside[open]{transform:none;}
aside h2{padding:1rem .9rem;font-size:1.1rem;border-bottom:1px solid #ddd;}
#toc ul{list-style:none;padding-inline-start:.9rem;}
#toc li{padding:.28rem .15rem;cursor:pointer;}
#toc li:hover{background:#e2e8ff;}
main{padding:1rem;max-width:60rem;margin-inline:auto;}
section{margin-block-end:2rem;border-block-end:1px solid #eee;}
section header{display:flex;align-items:center;gap:.6rem;margin-block-end:.5rem;}
section header h3{font-size:1.05rem;line-height:1.3;}
.tag{background:var(--tag);color:#3746bb;font-size:.75rem;padding:.1rem .4rem;border-radius:4px;}
.askBtn{margin-inline-start:auto;font-size:.8rem;border:1px solid var(--accent);padding:.32rem .6rem;border-radius:3px;background:#fff;color:var(--accent);cursor:pointer;}
details[open] summary::after{content:"▲";float:inline-end;font-size:.7rem;}
details summary::after{content:"▼";float:inline-end;font-size:.7rem;}
summary{list-style:none;}
.loading{text-align:center;padding:3rem;font-style:italic;}
#filterBox{display:flex;flex-direction:column;padding:0 .9rem 1rem;}
#filterBox label{font-size:.82rem;margin-block:.15rem;}
@media(min-width:768px){
  aside{transform:none;}
  main{margin-inline-start:var(--sidebar);}
}
</style>
</head>
<body>
<header>
  <button id="menuBtn" aria-label="Toggle Table of Contents">☰</button>
  <h1>H.R. 1 (EAS) — 119th Congress</h1>
  <input id="search" type="search" placeholder="Search full text…">
</header>

<aside id="sidebar">
  <h2>Table of Contents</h2>
  <nav id="toc"></nav>
  <fieldset id="filterBox">
    <legend>Filter by committee</legend>
    <div id="filters"></div>
  </fieldset>
</aside>

<main id="content"><p class="loading">Loading bill…</p></main>

<!-- lightweight CDN libs -->
<script src="https://unpkg.com/pdfjs-dist@4.2.67/build/pdf.min.js"></script>
<script src="https://unpkg.com/fuse.js@6.6.2"></script>
<script>
/*-- PDF.JS worker from the same CDN --*/
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://unpkg.com/pdfjs-dist@4.2.67/build/pdf.worker.min.js';

/* DOM refs */
const PDF_FILE = 'BILLS-119hr1eas.pdf';
const sidebar  = document.getElementById('sidebar');
const menuBtn  = document.getElementById('menuBtn');
const tocEl    = document.getElementById('toc');
const content  = document.getElementById('content');
const searchIn = document.getElementById('search');
const filtersDiv = document.getElementById('filters');
menuBtn.onclick = ()=> sidebar.toggleAttribute('open');

/* globals */
let sections=[];          // {id,title,text,start,committee}

/*———————— 1. Load + outline flatten ————————*/
(async function init(){
  const pdf = await pdfjsLib.getDocument(PDF_FILE).promise;
  const outline = await pdf.getOutline();
  const flat = await flattenOutline(outline,pdf);           // ordered by page
  for(let i=0;i<flat.length;i++){
    const {item,page} = flat[i];
    const end = (i+1<flat.length) ? flat[i+1].page-1 : pdf.numPages-1;
    const text = await pagesText(pdf,page,end);
    const comm = committeeFrom(item.title);
    const id   = 'p'+page;
    sections.push({id,title:item.title,text,committee:comm,start:page});
    renderSection({id,title:item.title,text,committee:comm});
    addTocEntry(item.title,id);
  }
  content.querySelector('.loading')?.remove();
  buildSearch();
  buildFilters();
})();

/*———————— 2. Helpers ————————*/
async function flattenOutline(items,pdf,arr=[],depth=0){
  for(const item of (items||[])){
    const dest = await pdf.getDestination(item.dest);
    const idx  = await pdf.getPageIndex(dest[0]);  // 0-based
    arr.push({item,page:idx});
    if(item.items?.length) await flattenOutline(item.items,pdf,arr,depth+1);
  }
  return arr.sort((a,b)=>a.page-b.page);
}
async function pagesText(pdf,start,end){
  let out='';
  for(let p=start;p<=end;p++){
    const page = await pdf.getPage(p+1);                 // 1-based accessor
    const tc   = await page.getTextContent();
    out += tc.items.map(i=>i.str).join(' ') + '\n';
  }
  return out.trim();
}
function committeeFrom(title){
  const m=/COMMITTEE ON ([A-Z ,&/-]+)/.exec(title.toUpperCase());
  return m ? m[1].trim() : 'Unknown';
}

/*———————— 3. UI builders ————————*/
function addTocEntry(title,id){
  const li=document.createElement('li'); li.textContent=title;
  li.onclick=()=>document.getElementById(id).scrollIntoView({behavior:'smooth'});
  tocEl.appendChild(li);
}
function renderSection({id,title,text,committee}){
  const det=document.createElement('details');
  det.id=id;
  det.innerHTML=`
   <summary>
     <header>
       <h3>${title}</h3>
       <span class="tag">${committee}</span>
       <button class="askBtn" type="button">Ask ChatGPT</button>
     </header>
   </summary>
   <pre>${text.replace(/[&<>"']/g, c=>({&:'&amp;',<:'&lt;',>:'&gt;',"'":'&#39;','"':'&quot;'}[c]))}</pre>`;
  det.querySelector('.askBtn').onclick=()=>askChatGPT(text);
  content.appendChild(det);
}
function buildFilters(){
  const committees=[...new Set(sections.map(s=>s.committee))].sort();
  committees.forEach(c=>{
    const lab=document.createElement('label');
    lab.innerHTML=`<input type="checkbox" data-c="${c}" checked> ${c}`;
    filtersDiv.appendChild(lab);
  });
  filtersDiv.onchange=()=>{
    const act=[...filtersDiv.querySelectorAll('input:checked')].map(i=>i.dataset.c);
    sections.forEach(s=>{
      document.getElementById(s.id).hidden = !act.includes(s.committee);
    });
  };
}
function buildSearch(){
  const fuse=new Fuse(sections,{keys:['title','text'],minMatchCharLength:3,threshold:0.4});
  searchIn.oninput=e=>{
    const q=e.target.value.trim();
    if(!q){sections.forEach(s=>document.getElementById(s.id).hidden=false);return;}
    const hit=new Set(fuse.search(q).map(r=>r.item.id));
    sections.forEach(s=>document.getElementById(s.id).hidden=!hit.has(s.id));
  };
}

/*———————— 4. ChatGPT button ————————*/
function askChatGPT(secText){
  const prompt=encodeURIComponent(
`What does this section of the bill mean, and how could it affect me?

${secText}`);
  const url=`https://chat.openai.com/?input=${prompt}`;
  const win=window.open(url,'_blank');
  /* fallback after 1.2 s if deep-link discarded */
  setTimeout(()=>{
    try{if(!win.location.search.includes('input='))throw 0;}
    catch(e){
      navigator.clipboard.writeText(secText).then(()=>{
        alert('Section text copied – paste it into ChatGPT and ask what it means.');
      });
    }
  },1200);
}
</script>
</body>
</html>
