<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Interactive Bill Viewer</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{--accent:#0057e7;--bg:#fff;--text:#222;--tag:#e0e7ff;--sidebar:270px;}
*{box-sizing:border-box;margin:0;padding:0;}
body{font:15px/1.5 system-ui,sans-serif;background:var(--bg);color:var(--text);}
header{display:flex;align-items:center;gap:.5rem;padding:.6rem 1rem;background:var(--accent);color:#fff;}
header h1{font-size:1rem;flex:1;}
header input[type=search]{flex:2;max-width:320px;border:0;border-radius:4px;padding:.42rem .6rem;}
#menuBtn{background:none;border:0;font-size:1.55rem;color:#fff;cursor:pointer;}
#uploadLbl{font-size:1.3rem;cursor:pointer;}
#fileInput{display:none;}
aside{position:fixed;inset-block:0;inset-inline-start:0;width:var(--sidebar);background:#f7f8fb;
      overflow:auto;transform:translateX(-100%);transition:transform .3s;}
aside[open]{transform:none;}
aside h2{padding:1rem .9rem;font-size:1.1rem;border-bottom:1px solid #ddd;}
#toc ul{list-style:none;padding-inline-start:.9rem;}
#toc li{padding:.28rem .15rem;cursor:pointer;} #toc li:hover{background:#e2e8ff;}
main{padding:1rem;max-width:60rem;margin-inline:auto;}
section{margin-block-end:2rem;border-block-end:1px solid #eee;}
section header{display:flex;align-items:center;gap:.6rem;margin-block-end:.5rem;}
section header h3{font-size:1.05rem;line-height:1.3;}
.tag{background:var(--tag);color:#3746bb;font-size:.75rem;padding:.1rem .4rem;border-radius:4px;}
.askBtn{margin-inline-start:auto;font-size:.8rem;border:1px solid var(--accent);
        padding:.32rem .6rem;border-radius:3px;background:#fff;color:var(--accent);cursor:pointer;}
details[open] summary::after{content:"â–²";float:inline-end;font-size:.7rem;}
details summary::after{content:"â–¼";float:inline-end;font-size:.7rem;}
summary{list-style:none;}
.loading{text-align:center;padding:3rem;font-style:italic;}
#filterBox{display:flex;flex-direction:column;padding:0 .9rem 1rem;}
#filterBox label{font-size:.82rem;margin-block:.15rem;}
@media(min-width:768px){aside{transform:none;} main{margin-inline-start:var(--sidebar);}}
</style>
</head>
<body>
<header>
  <button id="menuBtn" aria-label="Toggle Table of Contents">â˜°</button>
  <h1 id="docTitle">Bill Viewer</h1>
  <input id="search" type="search" placeholder="Search full textâ€¦">
  <label id="uploadLbl" title="Open PDF" for="fileInput">ðŸ“‚</label>
  <input id="fileInput" type="file" accept="application/pdf">
</header>

<aside id="sidebar"><h2>Table of Contents</h2><nav id="toc"></nav>
  <fieldset id="filterBox"><legend>Filter by committee</legend><div id="filters"></div></fieldset>
</aside>

<main id="content"><p class="loading">Load a PDF with the ðŸ“‚ button â€¦</p></main>

<!-- libs -->
<script src="https://unpkg.com/pdfjs-dist@4.2.67/build/pdf.min.js"></script>
<script src="https://unpkg.com/fuse.js@6.6.2"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://unpkg.com/pdfjs-dist@4.2.67/build/pdf.worker.min.js';

/* â€”â€”â€” DOM refs â€”â€”â€” */
const sidebar = document.getElementById('sidebar');
const menuBtn = document.getElementById('menuBtn');
const tocEl   = document.getElementById('toc');
const content = document.getElementById('content');
const searchIn= document.getElementById('search');
const filters = document.getElementById('filters');
const fileIn  = document.getElementById('fileInput');
const titleEl = document.getElementById('docTitle');
menuBtn.onclick = ()=>sidebar.toggleAttribute('open');

/* â€”â€”â€” reactive globals â€”â€”â€” */
let fuse, sections=[];

/* â€”â€”â€” file upload â€”â€”â€” */
fileIn.onchange = async e=>{
  const file=e.target.files[0]; if(!file) return;
  titleEl.textContent=file.name;
  const buf=await file.arrayBuffer();
  await loadPDF({data:buf});
};

/* â€”â€”â€” optional default document â€”â€”â€” */
loadPDF('BILLS-119hr1eas.pdf').catch(()=>{});   // comment-out if you prefer a blank start

/* â€”â€”â€” main loader â€”â€”â€” */
async function loadPDF(src){
  /* reset UI */
  sections.length=0;
  tocEl.innerHTML=''; filters.innerHTML='';
  content.innerHTML='<p class="loading">Loading â€¦</p>';

  const pdf = await pdfjsLib.getDocument(src).promise;
  const outline = await pdf.getOutline();
  const flat = await flatten(outline,pdf);
  for(let i=0;i<flat.length;i++){
    const {item,page}=flat[i];
    const end = (i+1<flat.length)?flat[i+1].page-1:pdf.numPages-1;
    const text = await pagesText(pdf,page,end);
    const committee = committeeFrom(item.title);
    const id='p'+page;
    sections.push({id,title:item.title,text,committee});
    renderSection(id,item.title,text,committee);
    addTOC(item.title,id);
  }
  buildFilters(); buildSearch();
  content.querySelector('.loading')?.remove();
}

/* â€”â€”â€” helpers â€”â€”â€” */
async function flatten(items,pdf,a=[],d=0){
  for(const it of(items||[])){
    const dest=await pdf.getDestination(it.dest);
    const pg = await pdf.getPageIndex(dest[0]); // 0-based
    a.push({item:it,page:pg});
    if(it.items?.length) await flatten(it.items,pdf,a,d+1);
  }
  return a.sort((x,y)=>x.page-y.page);
}
async function pagesText(pdf,s,e){
  let out='';
  for(let p=s;p<=e;p++){
    const tc=await (await pdf.getPage(p+1)).getTextContent();
    out+=tc.items.map(i=>i.str).join(' ')+'\n';
  } return out.trim();
}
function committeeFrom(t){const m=/COMMITTEE ON ([A-Z ,&/-]+)/.exec(t.toUpperCase());
  return m?m[1].trim():'Unknown';}
function addTOC(t,id){
  const li=document.createElement('li'); li.textContent=t;
  li.onclick=()=>document.getElementById(id).scrollIntoView({behavior:'smooth'});
  tocEl.appendChild(li);
}
function renderSection(id,title,text,committee){
  const det=document.createElement('details'); det.id=id;
  det.innerHTML=`
   <summary><header><h3>${title}</h3><span class="tag">${committee}</span>
   <button class="askBtn" type="button">Ask ChatGPT</button></header></summary>
   <pre>${escapeHtml(text)}</pre>`;
  det.querySelector('.askBtn').onclick=()=>askChatGPT(text);
  content.appendChild(det);
}
function buildFilters(){
  const committees=[...new Set(sections.map(s=>s.committee))].sort();
  committees.forEach(c=>{
    const l=document.createElement('label');
    l.innerHTML=`<input type="checkbox" data-c="${c}" checked> ${c}`;
    filters.appendChild(l);
  });
  filters.onchange=()=>{
    const act=[...filters.querySelectorAll('input:checked')].map(i=>i.dataset.c);
    sections.forEach(s=>{
      document.getElementById(s.id).hidden=!act.includes(s.committee);
    });
  };
}
function buildSearch(){
  fuse=new Fuse(sections,{keys:['title','text'],threshold:0.4,minMatchCharLength:3});
  searchIn.oninput=e=>{
    const q=e.target.value.trim();
    if(!q){sections.forEach(s=>document.getElementById(s.id).hidden=false);return;}
    const hit=new Set(fuse.search(q).map(r=>r.item.id));
    sections.forEach(s=>document.getElementById(s.id).hidden=!hit.has(s.id));
  };
}
function escapeHtml(s){return s.replace(/[&<>"']/g,c=>({&:'&amp;',<:'&lt;',>:'&gt;',"'":'&#39;','"':'&quot;'}[c]));}
/* â€”â€”â€” ChatGPT helper â€”â€”â€” */
function askChatGPT(secText){
  const prompt=encodeURIComponent(`What does this section of the bill mean, and how could it affect me?\n\n${secText}`);
  const url=`https://chat.openai.com/?input=${prompt}`;
  const w=window.open(url,'_blank');
  setTimeout(()=>{try{if(!w.location.search.includes('input='))throw 0;}
    catch{navigator.clipboard.writeText(secText).then(()=>alert('Section text copied â€“ paste into ChatGPT.'));}},1200);
}
</script>
</body>
</html>
